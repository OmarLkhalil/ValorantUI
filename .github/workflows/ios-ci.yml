# GitHub Actions Workflow for iOS Build
# CI/CD Pipeline: Build iOS ‚Üí Test ‚Üí Screenshots ‚Üí TestFlight

name: iOS CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  XCODE_VERSION: '15.2'

jobs:
  # ==========================================
  # Job 1: Build iOS Framework
  # ==========================================
  build-ios-framework:
    name: Build iOS Framework
    runs-on: macos-14

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
          cache: 'gradle'

      - name: Select Xcode Version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build XCFramework
        run: |
          cd composeApp
          ./gradlew :composeApp:assembleXCFramework
          echo "‚úÖ XCFramework built successfully"

      - name: Upload XCFramework
        uses: actions/upload-artifact@v4
        with:
          name: ios-xcframework
          path: composeApp/build/XCFrameworks/
          retention-days: 7

  # ==========================================
  # Job 2: Build iOS App
  # ==========================================
  build-ios-app:
    name: Build iOS App
    needs: build-ios-framework
    runs-on: macos-14

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download XCFramework
        uses: actions/download-artifact@v4
        with:
          name: ios-xcframework
          path: composeApp/build/XCFrameworks/

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Install Dependencies (CocoaPods)
        run: |
          cd iosApp
          pod install || echo "No Podfile found"

      - name: Build iOS App (Simulator)
        run: |
          xcodebuild build \
            -scheme iosApp \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: Archive iOS App
        run: |
          xcodebuild archive \
            -scheme iosApp \
            -archivePath build/iosApp.xcarchive \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            -allowProvisioningUpdates || echo "Archiving skipped (requires signing)"

  # ==========================================
  # Job 3: iOS Screenshots
  # ==========================================
  ios-screenshots:
    name: Take iOS Screenshots
    needs: build-ios-framework
    runs-on: macos-14
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
          cache: 'gradle'

      - name: Download XCFramework
        uses: actions/download-artifact@v4
        with:
          name: ios-xcframework
          path: composeApp/build/XCFrameworks/

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Create Simulator
        run: |
          xcrun simctl create "iPhone 15 Pro" "iPhone 15 Pro" iOS17.2 || echo "Simulator exists"
          xcrun simctl boot "iPhone 15 Pro" || echo "Already booted"

      - name: Build for Testing
        run: |
          xcodebuild build-for-testing \
            -scheme iosApp \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -derivedDataPath build/DerivedData

      - name: Take Screenshots (UI Tests)
        run: |
          xcodebuild test-without-building \
            -xctestrun build/DerivedData/Build/Products/iosApp_iphonesimulator17.2-arm64.xctestrun \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -resultBundlePath build/TestResults || echo "No UI tests configured yet"

      - name: Extract Screenshots
        run: |
          mkdir -p screenshots/ios
          # Extract screenshots from test results
          find build/TestResults -name "*.png" -exec cp {} screenshots/ios/ \; || echo "No screenshots found"

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-screenshots
          path: screenshots/ios/
          retention-days: 30

  # ==========================================
  # Job 4: TestFlight Upload (Optional)
  # ==========================================
  deploy-testflight:
    name: Deploy to TestFlight
    needs: build-ios-app
    runs-on: macos-14
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Placeholder for TestFlight
        run: |
          echo "‚ö†Ô∏è TestFlight deployment requires:"
          echo "1. Apple Developer Account"
          echo "2. App Store Connect API Key"
          echo "3. Signing certificates"
          echo ""
          echo "Configure these in GitHub Secrets:"
          echo "- APP_STORE_CONNECT_API_KEY_ID"
          echo "- APP_STORE_CONNECT_API_ISSUER_ID"
          echo "- APP_STORE_CONNECT_API_KEY_CONTENT"
          echo "- CERTIFICATE_P12_BASE64"
          echo "- CERTIFICATE_PASSWORD"

  # ==========================================
  # Job 5: Generate Showcase Report
  # ==========================================
  generate-showcase:
    name: Generate Multiplatform Showcase
    needs: [build-ios-app, ios-screenshots]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download iOS Screenshots
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: ios-screenshots
          path: showcase/ios/

      - name: Download Android Screenshots
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: screenshots
          path: showcase/android/

      - name: Generate Showcase HTML
        run: |
          cat > showcase/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>ValorantUI - Kotlin Multiplatform Showcase</title>
            <style>
              body { font-family: Arial; max-width: 1200px; margin: 0 auto; padding: 20px; }
              h1 { color: #FF4655; text-align: center; }
              .platform { margin: 40px 0; }
              .screenshots { display: flex; flex-wrap: wrap; gap: 20px; }
              .screenshot { width: 300px; border: 1px solid #ddd; border-radius: 8px; }
              .screenshot img { width: 100%; border-radius: 8px; }
              .badge { display: inline-block; padding: 5px 10px; background: #FF4655; color: white; border-radius: 4px; margin: 5px; }
            </style>
          </head>
          <body>
            <h1>üéÆ ValorantUI - Kotlin Multiplatform</h1>
            <p style="text-align: center;">
              <span class="badge">‚úÖ Android</span>
              <span class="badge">‚úÖ iOS</span>
              <span class="badge">‚úÖ Compose Multiplatform</span>
            </p>
            
            <div class="platform">
              <h2>üì± Android Screenshots</h2>
              <div class="screenshots" id="android-screenshots"></div>
            </div>
            
            <div class="platform">
              <h2>üçé iOS Screenshots</h2>
              <div class="screenshots" id="ios-screenshots"></div>
            </div>
            
            <script>
              // Load Android screenshots
              const androidImages = [/* Add your android screenshot URLs */];
              const androidContainer = document.getElementById('android-screenshots');
              
              // Load iOS screenshots
              const iosImages = [/* Add your iOS screenshot URLs */];
              const iosContainer = document.getElementById('ios-screenshots');
              
              // Populate screenshots (you can automate this)
            </script>
          </body>
          </html>
          EOF

      - name: Upload Showcase
        uses: actions/upload-artifact@v4
        with:
          name: multiplatform-showcase
          path: showcase/
          retention-days: 90

      - name: Deploy to GitHub Pages (Optional)
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./showcase
          destination_dir: showcase

