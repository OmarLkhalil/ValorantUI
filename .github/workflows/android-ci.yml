# GitHub Actions Workflow for ValorantUI
# CI/CD Pipeline: Build â†’ Test â†’ Lint â†’ Distribute to Firebase

name: Android CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

env:
  JAVA_VERSION: 17

jobs:
  # ==========================================
  # Job 1: Build & Test
  # ==========================================
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Setup google-services.json
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          if [ -z "$GOOGLE_SERVICES_JSON" ]; then
            echo "âš ï¸ Warning: GOOGLE_SERVICES_JSON secret is not set"
            echo "Creating dummy google-services.json for build"
            cat > app/google-services.json << 'EOF'
          {
            "project_info": {
              "project_number": "000000000000",
              "project_id": "dummy-project",
              "storage_bucket": "dummy-project.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:000000000000:android:0000000000000000000000",
                  "android_client_info": {
                    "package_name": "com.larryyu.valorantui"
                  }
                },
                "oauth_client": [
                  {
                    "client_id": "000000000000-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com",
                    "client_type": 3
                  }
                ],
                "api_key": [
                  {
                    "current_key": "AIzaSyDummy-Key-For-CI-Build-Only-Not-Real"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": []
                  }
                }
              }
            ],
            "configuration_version": "1"
          }
          EOF
          else
            echo "âœ… Creating google-services.json from secret"
            echo "$GOOGLE_SERVICES_JSON" > app/google-services.json
          fi
          echo "google-services.json preview (first 3 lines):"
          head -3 app/google-services.json

      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace --no-daemon

      - name: Run Unit Tests
        run: ./gradlew test --stacktrace --no-daemon
        continue-on-error: true

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        continue-on-error: true
        with:
          files: |
            **/build/test-results/test*/**/*.xml
            **/build/test-results/testDebugUnitTest/**/*.xml
          check_name: 'Test Results'

      - name: Run Lint
        run: ./gradlew lint --stacktrace --no-daemon
        continue-on-error: true

      - name: Upload Lint Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-reports
          path: |
            app/build/reports/lint-results-*.html
            app/build/reports/lint-results-*.xml

      - name: Build Release APK
        run: ./gradlew assembleRelease --stacktrace --no-daemon

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/app-release.apk
          retention-days: 30

  # ==========================================
  # Job 2: Deploy to Firebase (Main Branch Only)
  # ==========================================
  deploy-firebase:
    name: Deploy to Firebase
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-release
          path: ./app-release

      - name: Deploy to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          groups: internal-testers
          file: ./app-release/app-release.apk
          releaseNotes: |
            ðŸš€ Automated Build from CI/CD
            
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            
            Changes:
            ${{ github.event.head_commit.message }}

      - name: Get Download Link
        run: |
          echo "âœ… APK deployed to Firebase App Distribution!"
          echo "ðŸ“² Testers will receive notification"

  # ==========================================
  # Job 3: Create Release (Tags Only)
  # ==========================================
  create-release:
    name: Create GitHub Release
    needs: build-and-test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-release
          path: ./

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: app-release.apk
          body: |
            ## ðŸŽ‰ Release ${{ github.ref_name }}
            
            ### What's Changed
            - Check commit history for details
            
            ### Download
            - Download the APK from the assets below

          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================
  # Job 4: Screenshots (Optional)
  # ==========================================
  screenshots:
    name: Take Screenshots
    runs-on: macos-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Setup google-services.json
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          echo "$GOOGLE_SERVICES_JSON" > app/google-services.json

      - name: AVD cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-29

      - name: Create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: false
          script: echo "Generated AVD snapshot for caching."

      - name: Run Instrumentation Tests & Take Screenshots
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          script: ./gradlew connectedCheck --stacktrace

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshots
          path: fastlane/screenshots/

  # ==========================================
  # Job 5: Notification (Optional)
  # ==========================================
  notify:
    name: Send Notifications
    needs: [build-and-test, deploy-firebase]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Build Status
        run: |
          echo "Build Status: ${{ job.status }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

